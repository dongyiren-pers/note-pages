<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务发现 | 后端技术栈笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="/note-pages//s0.pstatp.com/cdn/expire-1-M/jquery/3.4.0/jquery.min.js"></script>
    <script src="/note-pages//s0.pstatp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" href="/note-pages//s0.pstatp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">
    <meta name="description" content="BackEnd Notes">
    
    <link rel="preload" href="/note-pages/assets/css/0.styles.167a34c7.css" as="style"><link rel="preload" href="/note-pages/assets/js/app.05dcbd87.js" as="script"><link rel="preload" href="/note-pages/assets/js/3.4a2f67fd.js" as="script"><link rel="preload" href="/note-pages/assets/js/2.ab82720e.js" as="script"><link rel="preload" href="/note-pages/assets/js/57.b3f75d67.js" as="script"><link rel="prefetch" href="/note-pages/assets/js/10.e11a80d9.js"><link rel="prefetch" href="/note-pages/assets/js/100.489cf69a.js"><link rel="prefetch" href="/note-pages/assets/js/101.560e37ea.js"><link rel="prefetch" href="/note-pages/assets/js/102.baaa4f6a.js"><link rel="prefetch" href="/note-pages/assets/js/103.262b6423.js"><link rel="prefetch" href="/note-pages/assets/js/104.ac33d7ce.js"><link rel="prefetch" href="/note-pages/assets/js/105.5e6ce18f.js"><link rel="prefetch" href="/note-pages/assets/js/106.a69322ef.js"><link rel="prefetch" href="/note-pages/assets/js/107.6cdb78ee.js"><link rel="prefetch" href="/note-pages/assets/js/108.1d720289.js"><link rel="prefetch" href="/note-pages/assets/js/109.58f7297c.js"><link rel="prefetch" href="/note-pages/assets/js/11.241a46da.js"><link rel="prefetch" href="/note-pages/assets/js/110.9cef761d.js"><link rel="prefetch" href="/note-pages/assets/js/111.c782138c.js"><link rel="prefetch" href="/note-pages/assets/js/112.40cb3b1a.js"><link rel="prefetch" href="/note-pages/assets/js/113.c367e40a.js"><link rel="prefetch" href="/note-pages/assets/js/114.a4a75db5.js"><link rel="prefetch" href="/note-pages/assets/js/115.a73cd469.js"><link rel="prefetch" href="/note-pages/assets/js/116.ad853155.js"><link rel="prefetch" href="/note-pages/assets/js/117.a82b2649.js"><link rel="prefetch" href="/note-pages/assets/js/118.8f896dd0.js"><link rel="prefetch" href="/note-pages/assets/js/119.374482b1.js"><link rel="prefetch" href="/note-pages/assets/js/12.ebe220d5.js"><link rel="prefetch" href="/note-pages/assets/js/120.89698284.js"><link rel="prefetch" href="/note-pages/assets/js/121.cbe50685.js"><link rel="prefetch" href="/note-pages/assets/js/122.7de2ac51.js"><link rel="prefetch" href="/note-pages/assets/js/123.a2d16009.js"><link rel="prefetch" href="/note-pages/assets/js/124.e1ba7cbe.js"><link rel="prefetch" href="/note-pages/assets/js/125.4e1e6d6a.js"><link rel="prefetch" href="/note-pages/assets/js/126.3db22af3.js"><link rel="prefetch" href="/note-pages/assets/js/127.937f4ffc.js"><link rel="prefetch" href="/note-pages/assets/js/128.0bad2e20.js"><link rel="prefetch" href="/note-pages/assets/js/129.75a99d25.js"><link rel="prefetch" href="/note-pages/assets/js/13.5ee7bef5.js"><link rel="prefetch" href="/note-pages/assets/js/130.599b6d3d.js"><link rel="prefetch" href="/note-pages/assets/js/131.687214bf.js"><link rel="prefetch" href="/note-pages/assets/js/132.8295c067.js"><link rel="prefetch" href="/note-pages/assets/js/133.854d61c0.js"><link rel="prefetch" href="/note-pages/assets/js/134.f3fc20e1.js"><link rel="prefetch" href="/note-pages/assets/js/135.2a5a690d.js"><link rel="prefetch" href="/note-pages/assets/js/136.6ba30378.js"><link rel="prefetch" href="/note-pages/assets/js/137.80d7c511.js"><link rel="prefetch" href="/note-pages/assets/js/138.0a25898e.js"><link rel="prefetch" href="/note-pages/assets/js/139.fb3c377f.js"><link rel="prefetch" href="/note-pages/assets/js/14.a561f8b3.js"><link rel="prefetch" href="/note-pages/assets/js/140.cbfdbe32.js"><link rel="prefetch" href="/note-pages/assets/js/141.c09f054f.js"><link rel="prefetch" href="/note-pages/assets/js/142.723bd973.js"><link rel="prefetch" href="/note-pages/assets/js/143.b31785f9.js"><link rel="prefetch" href="/note-pages/assets/js/144.69d3d121.js"><link rel="prefetch" href="/note-pages/assets/js/145.c4ee6aa0.js"><link rel="prefetch" href="/note-pages/assets/js/146.7f836a1c.js"><link rel="prefetch" href="/note-pages/assets/js/147.d4a57976.js"><link rel="prefetch" href="/note-pages/assets/js/148.b15e75eb.js"><link rel="prefetch" href="/note-pages/assets/js/149.94085ddc.js"><link rel="prefetch" href="/note-pages/assets/js/15.4ed118f1.js"><link rel="prefetch" href="/note-pages/assets/js/150.6751d41b.js"><link rel="prefetch" href="/note-pages/assets/js/151.bd60e322.js"><link rel="prefetch" href="/note-pages/assets/js/152.15caf78f.js"><link rel="prefetch" href="/note-pages/assets/js/153.131128fc.js"><link rel="prefetch" href="/note-pages/assets/js/154.b8ee2e7d.js"><link rel="prefetch" href="/note-pages/assets/js/155.8fa1e2e0.js"><link rel="prefetch" href="/note-pages/assets/js/156.25e2a796.js"><link rel="prefetch" href="/note-pages/assets/js/157.7137c9c3.js"><link rel="prefetch" href="/note-pages/assets/js/158.fdc18c40.js"><link rel="prefetch" href="/note-pages/assets/js/159.0dadb745.js"><link rel="prefetch" href="/note-pages/assets/js/16.818fc8bf.js"><link rel="prefetch" href="/note-pages/assets/js/160.05f7541c.js"><link rel="prefetch" href="/note-pages/assets/js/161.2a8c62a2.js"><link rel="prefetch" href="/note-pages/assets/js/162.5b9983b7.js"><link rel="prefetch" href="/note-pages/assets/js/163.b51a5538.js"><link rel="prefetch" href="/note-pages/assets/js/164.06c9f20a.js"><link rel="prefetch" href="/note-pages/assets/js/165.c25063f4.js"><link rel="prefetch" href="/note-pages/assets/js/166.6c570da5.js"><link rel="prefetch" href="/note-pages/assets/js/167.12fb6fb6.js"><link rel="prefetch" href="/note-pages/assets/js/168.d7dd27bc.js"><link rel="prefetch" href="/note-pages/assets/js/169.27f575fe.js"><link rel="prefetch" href="/note-pages/assets/js/17.9daf0c47.js"><link rel="prefetch" href="/note-pages/assets/js/170.ba4295ef.js"><link rel="prefetch" href="/note-pages/assets/js/171.3fb54078.js"><link rel="prefetch" href="/note-pages/assets/js/18.086ed162.js"><link rel="prefetch" href="/note-pages/assets/js/19.adca670c.js"><link rel="prefetch" href="/note-pages/assets/js/20.2e9ff004.js"><link rel="prefetch" href="/note-pages/assets/js/21.07830947.js"><link rel="prefetch" href="/note-pages/assets/js/22.609929cb.js"><link rel="prefetch" href="/note-pages/assets/js/23.d83b832f.js"><link rel="prefetch" href="/note-pages/assets/js/24.592e8014.js"><link rel="prefetch" href="/note-pages/assets/js/25.9d28bb6f.js"><link rel="prefetch" href="/note-pages/assets/js/26.fd4195d5.js"><link rel="prefetch" href="/note-pages/assets/js/27.ca60e875.js"><link rel="prefetch" href="/note-pages/assets/js/28.c2cd75e6.js"><link rel="prefetch" href="/note-pages/assets/js/29.4213d132.js"><link rel="prefetch" href="/note-pages/assets/js/30.c6ee0ead.js"><link rel="prefetch" href="/note-pages/assets/js/31.eea6a542.js"><link rel="prefetch" href="/note-pages/assets/js/32.1ffdceaf.js"><link rel="prefetch" href="/note-pages/assets/js/33.0425748b.js"><link rel="prefetch" href="/note-pages/assets/js/34.5dd0d81d.js"><link rel="prefetch" href="/note-pages/assets/js/35.773df14e.js"><link rel="prefetch" href="/note-pages/assets/js/36.5db32ea2.js"><link rel="prefetch" href="/note-pages/assets/js/37.1106162c.js"><link rel="prefetch" href="/note-pages/assets/js/38.793ba7d0.js"><link rel="prefetch" href="/note-pages/assets/js/39.488fb9a5.js"><link rel="prefetch" href="/note-pages/assets/js/4.550e6883.js"><link rel="prefetch" href="/note-pages/assets/js/40.9c05b0ae.js"><link rel="prefetch" href="/note-pages/assets/js/41.ae198526.js"><link rel="prefetch" href="/note-pages/assets/js/42.d815456e.js"><link rel="prefetch" href="/note-pages/assets/js/43.1808aff8.js"><link rel="prefetch" href="/note-pages/assets/js/44.c26d9bde.js"><link rel="prefetch" href="/note-pages/assets/js/45.fae5f755.js"><link rel="prefetch" href="/note-pages/assets/js/46.703057c9.js"><link rel="prefetch" href="/note-pages/assets/js/47.ed3a23ce.js"><link rel="prefetch" href="/note-pages/assets/js/48.c5a46ee8.js"><link rel="prefetch" href="/note-pages/assets/js/49.b04c1681.js"><link rel="prefetch" href="/note-pages/assets/js/5.869d288f.js"><link rel="prefetch" href="/note-pages/assets/js/50.249fc2a7.js"><link rel="prefetch" href="/note-pages/assets/js/51.cab74632.js"><link rel="prefetch" href="/note-pages/assets/js/52.e2f231b3.js"><link rel="prefetch" href="/note-pages/assets/js/53.6241e308.js"><link rel="prefetch" href="/note-pages/assets/js/54.7d29c5c0.js"><link rel="prefetch" href="/note-pages/assets/js/55.a9050f95.js"><link rel="prefetch" href="/note-pages/assets/js/56.75828a09.js"><link rel="prefetch" href="/note-pages/assets/js/58.0cf3bd1c.js"><link rel="prefetch" href="/note-pages/assets/js/59.19f18f1f.js"><link rel="prefetch" href="/note-pages/assets/js/6.d879438f.js"><link rel="prefetch" href="/note-pages/assets/js/60.61940d92.js"><link rel="prefetch" href="/note-pages/assets/js/61.bc890bb0.js"><link rel="prefetch" href="/note-pages/assets/js/62.f487437c.js"><link rel="prefetch" href="/note-pages/assets/js/63.4a91369b.js"><link rel="prefetch" href="/note-pages/assets/js/64.1b0770e4.js"><link rel="prefetch" href="/note-pages/assets/js/65.b56e2b22.js"><link rel="prefetch" href="/note-pages/assets/js/66.dd49594c.js"><link rel="prefetch" href="/note-pages/assets/js/67.22efede4.js"><link rel="prefetch" href="/note-pages/assets/js/68.0d22a8a4.js"><link rel="prefetch" href="/note-pages/assets/js/69.aec9bfeb.js"><link rel="prefetch" href="/note-pages/assets/js/7.e3626849.js"><link rel="prefetch" href="/note-pages/assets/js/70.0c53c20d.js"><link rel="prefetch" href="/note-pages/assets/js/71.6d6db7d6.js"><link rel="prefetch" href="/note-pages/assets/js/72.fdcfb985.js"><link rel="prefetch" href="/note-pages/assets/js/73.a390b48d.js"><link rel="prefetch" href="/note-pages/assets/js/74.e817987f.js"><link rel="prefetch" href="/note-pages/assets/js/75.f144cf4f.js"><link rel="prefetch" href="/note-pages/assets/js/76.7be2f5f1.js"><link rel="prefetch" href="/note-pages/assets/js/77.6568d596.js"><link rel="prefetch" href="/note-pages/assets/js/78.4ff63ca8.js"><link rel="prefetch" href="/note-pages/assets/js/79.daaf791e.js"><link rel="prefetch" href="/note-pages/assets/js/8.f9f716a1.js"><link rel="prefetch" href="/note-pages/assets/js/80.a0605696.js"><link rel="prefetch" href="/note-pages/assets/js/81.ecb125f5.js"><link rel="prefetch" href="/note-pages/assets/js/82.b64b1c42.js"><link rel="prefetch" href="/note-pages/assets/js/83.d13b7f19.js"><link rel="prefetch" href="/note-pages/assets/js/84.c584da75.js"><link rel="prefetch" href="/note-pages/assets/js/85.7992353f.js"><link rel="prefetch" href="/note-pages/assets/js/86.17ad6399.js"><link rel="prefetch" href="/note-pages/assets/js/87.289f9f2f.js"><link rel="prefetch" href="/note-pages/assets/js/88.3496d6e2.js"><link rel="prefetch" href="/note-pages/assets/js/89.0d0c778d.js"><link rel="prefetch" href="/note-pages/assets/js/9.3209071f.js"><link rel="prefetch" href="/note-pages/assets/js/90.245b9fda.js"><link rel="prefetch" href="/note-pages/assets/js/91.806af5f2.js"><link rel="prefetch" href="/note-pages/assets/js/92.8a10f401.js"><link rel="prefetch" href="/note-pages/assets/js/93.ea90ae18.js"><link rel="prefetch" href="/note-pages/assets/js/94.98cc66ef.js"><link rel="prefetch" href="/note-pages/assets/js/95.836e96c5.js"><link rel="prefetch" href="/note-pages/assets/js/96.d4dd3eee.js"><link rel="prefetch" href="/note-pages/assets/js/97.e4275cb9.js"><link rel="prefetch" href="/note-pages/assets/js/98.0e320d92.js"><link rel="prefetch" href="/note-pages/assets/js/99.e6f77650.js">
    <link rel="stylesheet" href="/note-pages/assets/css/0.styles.167a34c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-pages/" class="home-link router-link-active"><!----> <span class="site-name">后端技术栈笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-pages/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/algorithm/5e022a/" class="nav-link">
  算法
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机网络
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/network/a918ca/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/note-pages/http/" class="nav-link">
  HTTP
</a></li><li class="dropdown-subitem"><a href="/note-pages/tcp-ip/" class="nav-link">
  TCP/IP
</a></li><li class="dropdown-subitem"><a href="/note-pages/socket/" class="nav-link">
  Socket
</a></li></ul></li><li class="dropdown-item"><h4>
          操作系统
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/operating-system/knuk3x/" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/note-pages/linux/" class="nav-link">
  Linux
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/database-system/fyl5c1/" class="nav-link">
  数据库系统
</a></li><li class="dropdown-subitem"><a href="/note-pages/computer-systems/" class="nav-link">
  计算机系统
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/java/5ddf72/" class="nav-link">
  Java基础
</a></li><li class="dropdown-subitem"><a href="/note-pages/java-collection/" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/note-pages/java-concurrency/" class="nav-link">
  Java并发
</a></li><li class="dropdown-subitem"><a href="/note-pages/jvm/" class="nav-link">
  JVM
</a></li></ul></li><li class="dropdown-item"><h4>
          C/C++
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/cpp/" class="nav-link">
  C++基础
</a></li></ul></li><li class="dropdown-item"><h4>
          Go
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/go/" class="nav-link">
  Go基础
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/assembly/" class="nav-link">
  Assembly
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发框架" class="dropdown-title"><span class="title">开发框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发框架" class="mobile-dropdown-title"><span class="title">开发框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/spring/" class="nav-link router-link-active">
  Spring
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/mysql/1dh29a/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/note-pages/redis/" class="nav-link">
  Redis
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构设计" class="dropdown-title"><span class="title">架构设计</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构设计" class="mobile-dropdown-title"><span class="title">架构设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          分布式
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/distributed-system/01-理论基础/" class="nav-link">
  分布式系统
</a></li></ul></li><li class="dropdown-item"><h4>
          微服务
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/micro-service-in-action/" class="nav-link">
  微服务实战
</a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-subitem"><a href="/note-pages/rocket-mq/" class="nav-link">
  RocketMQ
</a></li></ul></li><li class="dropdown-item"><h4>
          注册中心
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/zookeeper/" class="nav-link">
  ZooKeeper
</a></li><li class="dropdown-subitem"><a href="/note-pages/eureka/" class="nav-link">
  Eureka
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发工具" class="mobile-dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-pages/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/note-pages/docker/34kd5q/" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="理论方法" class="dropdown-title"><span class="title">理论方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="理论方法" class="mobile-dropdown-title"><span class="title">理论方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-pages/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/note-pages/software-engineering/n4r1lx/" class="nav-link">
  软件工程
</a></li></ul></div></div><div class="nav-item"><a href="/note-pages/interview/f05h67/" class="nav-link">
  面试通关
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note-pages/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/algorithm/5e022a/" class="nav-link">
  算法
</a></li></ul></li><li class="dropdown-item"><h4>
          计算机网络
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/network/a918ca/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/note-pages/http/" class="nav-link">
  HTTP
</a></li><li class="dropdown-subitem"><a href="/note-pages/tcp-ip/" class="nav-link">
  TCP/IP
</a></li><li class="dropdown-subitem"><a href="/note-pages/socket/" class="nav-link">
  Socket
</a></li></ul></li><li class="dropdown-item"><h4>
          操作系统
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/operating-system/knuk3x/" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/note-pages/linux/" class="nav-link">
  Linux
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/database-system/fyl5c1/" class="nav-link">
  数据库系统
</a></li><li class="dropdown-subitem"><a href="/note-pages/computer-systems/" class="nav-link">
  计算机系统
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/java/5ddf72/" class="nav-link">
  Java基础
</a></li><li class="dropdown-subitem"><a href="/note-pages/java-collection/" class="nav-link">
  Java集合
</a></li><li class="dropdown-subitem"><a href="/note-pages/java-concurrency/" class="nav-link">
  Java并发
</a></li><li class="dropdown-subitem"><a href="/note-pages/jvm/" class="nav-link">
  JVM
</a></li></ul></li><li class="dropdown-item"><h4>
          C/C++
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/cpp/" class="nav-link">
  C++基础
</a></li></ul></li><li class="dropdown-item"><h4>
          Go
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/go/" class="nav-link">
  Go基础
</a></li></ul></li><li class="dropdown-item"><h4>
          其他
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/assembly/" class="nav-link">
  Assembly
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发框架" class="dropdown-title"><span class="title">开发框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发框架" class="mobile-dropdown-title"><span class="title">开发框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/spring/" class="nav-link router-link-active">
  Spring
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/mysql/1dh29a/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/note-pages/redis/" class="nav-link">
  Redis
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构设计" class="dropdown-title"><span class="title">架构设计</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构设计" class="mobile-dropdown-title"><span class="title">架构设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          分布式
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/distributed-system/01-理论基础/" class="nav-link">
  分布式系统
</a></li></ul></li><li class="dropdown-item"><h4>
          微服务
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/micro-service-in-action/" class="nav-link">
  微服务实战
</a></li></ul></li><li class="dropdown-item"><h4>
          消息队列
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-subitem"><a href="/note-pages/rocket-mq/" class="nav-link">
  RocketMQ
</a></li></ul></li><li class="dropdown-item"><h4>
          注册中心
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-pages/zookeeper/" class="nav-link">
  ZooKeeper
</a></li><li class="dropdown-subitem"><a href="/note-pages/eureka/" class="nav-link">
  Eureka
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><span class="title">开发工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="开发工具" class="mobile-dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-pages/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/note-pages/docker/34kd5q/" class="nav-link">
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="理论方法" class="dropdown-title"><span class="title">理论方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="理论方法" class="mobile-dropdown-title"><span class="title">理论方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-pages/design-pattern/" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/note-pages/software-engineering/n4r1lx/" class="nav-link">
  软件工程
</a></li></ul></div></div><div class="nav-item"><a href="/note-pages/interview/f05h67/" class="nav-link">
  面试通关
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 的核心</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web 中的 Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>云原生 Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note-pages/spring/云原生Spring/服务发现.html" class="active sidebar-link">服务发现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/服务发现.html#深入思考微服务" class="sidebar-link">深入思考微服务</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/服务发现.html#配置服务注册" class="sidebar-link">配置服务注册</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/服务发现.html#注册并发现服务" class="sidebar-link">注册并发现服务</a></li></ul></li><li><a href="/note-pages/spring/云原生Spring/配置管理.html" class="sidebar-link">配置管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#独立配置和集中式配置" class="sidebar-link">独立配置和集中式配置</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#运行配置服务器" class="sidebar-link">运行配置服务器</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#消费共享的配置" class="sidebar-link">消费共享的配置</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#消费特定的配置" class="sidebar-link">消费特定的配置</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#为配置的属性加密" class="sidebar-link">为配置的属性加密</a></li><li class="sidebar-sub-header"><a href="/note-pages/spring/云原生Spring/配置管理.html#远程刷新配置属性" class="sidebar-link">远程刷新配置属性</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 揭秘</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="服务发现"><a href="#服务发现" class="header-anchor">#</a> 服务发现</h1> <h2 id="深入思考微服务"><a href="#深入思考微服务" class="header-anchor">#</a> 深入思考微服务</h2> <p>单体应用程序构建到一个可部署的 JAR 或 WAR 文件中。开发成单体应用是很正常，几十年来大多数应用程序都是这样构建的。即使将应用程序分解为多模块构建，最终也仍然会得到一个 JAR 或 WAR 文件，然后再将其推送到生产环境中。</p> <p>这无疑是构建小型、简单应用程序的最适宜的方法。但有趣的是，小型应用程序往往会增长。当需要一个新的特性时，很容易在项目中添加更多的代码。在你意识到大事不妙之前，你的应用就已经变成复杂的单体的应用了。</p> <p><strong>单体应用程序看似简单，但存在以下这些问题：</strong></p> <ul><li>复杂度高—— 代码越多，就越难理顺每个组件在整个应用程序中的作用。</li> <li>测试更困难 —— 随着应用程序的增长，测试变得更加困难，整体验收测试变得更加复杂。</li> <li>更容易发生库冲突 —— 一个功能可能需要某个依赖，但这与另一个所需的依赖又无法兼容。</li> <li>不易扩展—— 如果需要将应用程序部署到更多节点，以扩展性能，会发现效率很低。因为即使只是应用程序的一小部分需要扩展，也必须将整个应用程序全部部署。</li> <li>技术选型会影响整体—— 当需要为应用做技术选型时，如：为应用程序选择语言、运行时平台、框架或库，是为整个应用程序在选择它。</li> <li>部署上线工作更复杂 —— 虽然看起来当一个应用程序只有一个部署单元时，很容易就可以部署到生产环境。然而，由于单体应用的规模和复杂性很大，应用程序通常需要一个更严格的开发过程和更长的测试周期。以确保所部署代码的质量，以及不会因此引起其他问题。</li></ul> <p>在过去的几年中，微服务架构已经兴起以应对这些挑战。简单来说，<strong>微服务架构</strong> 是将应用程序分解成小规模应用的办法，这些小应用独立开发和部署。这些小应用（微服务）相互协调，以提供更完整和强大的应用程序。与单体应用程序架构相比，<strong>微服务体系架构有以下特点：</strong></p> <ul><li>很容易理解 —— 在一个大的应用程序中，每个微服务与其他微服务之间的联系是有限的。因此，微服务的目标更加明确，作为一个完整单元更容易理解。</li> <li>更容易测试 —— 越小的东西越容易测试。这一点是显而易见的，比如单元测试和集成测试、验收测试相比。当然这个原则也适用于测试微服务和测试单体应用的情况。</li> <li>不太可能出现不兼容 —— 因为每个微服务都有自己的一组构建依赖项，这些依赖项不与其他服务共享。在微服务中，发生冲突的可能性较小。</li> <li>更易扩展 —— 如果任何给定的微服务需要更多资源，微服务可以独立扩展。可以独立计算内存分配和实例数，而不影响其他微服务的内存或实例。</li> <li>技术选型更方便 —— 对于每个完全不同的微服务，技术选择可以不同。可以就语言、平台、框架，以及每个微服务的依赖库进行选择。事实上，一个用 Java 编写的微服务，与另一个用 C# 编写的微服务进行通讯，是完全合理的。</li> <li>可以更频繁的部署 —— 一个应用程序由许多微服务组成，每个微服务都可以独立部署，而不要求任何其他微服务必须部署。因为它们更小，更专注，更容易测试，所以将微服务投入生产环境中的步骤就更少。从有一个想法，到在生产中看到它，使用微服务架构可能在几分钟内或几个小时就可以做到。而不是像单体应用架构那样，一般要几个星期或几个月。</li></ul> <p>微服务架构面临的另一个常见挑战是，一个服务如何了解与之协调工作的其他服务。这正是本文的主题。接下来让我们看看，如何使用 Spring Cloud 建立服务注册中心。</p> <h2 id="配置服务注册"><a href="#配置服务注册" class="header-anchor">#</a> 配置服务注册</h2> <p>Spring Cloud 是一个相当大的 “一揽子” 项目。它由几个独立的子项目组成，每一个都以某种方式支持微服务的开发。其中之一是 Spring Cloud Netflix 子项目，它提供了源自 Netflix 的几个组件。其中包括 Eureka，源自 Netflix 的服务注册中心。</p> <div class="subtitle"><p>Eureka 背后的故事</p></div><p>Eureka 这个词表达的含义，是当一个人找到或发现某事时的一种喜悦的感叹。这个含义，使其成为服务注册中心的最合适的命名。微服务正是通过 Eureka 服务发现彼此。</p> <p><strong>Eureka 充当微服务应用程序中，所有服务的中心注册表</strong>。Eureka 本身可以被认为是一个微型的服务，其目的是在更大的范围内帮助其他服务发现彼此。</p> <p>当一个服务实例启动时，它将用自己名称向 Eureka 注册。在下图中，服务名称代表某个服务。某个服务可能有多个等效实例，他们都以相同的名字在 Eureka 中注册。</p> <p><img src="/note-pages/assets/img/image-20221215191213209.55661826.png" alt="image-20221215191213209"></p> <p>在某个时候，另一个服务（other-service）需要使用到某些服务（some-service）时，不是用硬编码的方式，调用以某个特定主机和端口代表的服务，而是在 Eureka 中通过名称查找服务。Eureka 回复它所知道的相关服务的所有实例信息。</p> <p>现在 othere-service 需要做出决定。它将使用哪个服务实例？如果服务都是等价的，那没什么关系。但是为了避免每次都选择同一实例，最好应用一些客户端负载均衡算法以分散请求。这是另一个 Netflix 项目 Ribbon 专门解决的问题。</p> <p>尽管 other-service 可能只负责查找和选择 some-service 的实例，但它也要依赖于 Ribbon。Ribbon 是客户端负载均衡器，用于对 some-service 进行选择。一旦 Ribbon 做出选择后，剩下的就是实际发送请求了。</p> <div class="subtitle"><p>客户端负载均衡器</p></div><p>通常，负载均衡器被认为是一个单一的、集中式服务，处理所有请求并将请求分发到目标的多个实例中。相反，Ribbon 是一个客户端负载均衡器，请求都是本地的客户端发出的。</p> <p>作为客户端负载均衡器，Ribbon 比集中式负载均衡器有几个优点。因为每个客户端都有一个本地负载均衡器，所以扩展时，负载均衡器与客户端数量成比例。此外，每个负载均衡器可以使用最适合自己的负载均衡算法，而不是对所有服务应用相同的配置。</p> <div class="subtitle"><p>启用 Eureka 服务注册中心</p></div><p>要开始使用 Spring Cloud 和 Eureka，需要创建一个全新的 Eureka 服务项目。最简单的方法是使用 Spring Initializr，我们把这个项目命名为 service-registry。当需要选择 starter 依赖项时，只有一个工作：勾选名称为 Eureka Server 的复选框。创建新项目之后，Initializr 会为我们提供一个 pom.xml 文件，文件中包含以下依赖关系：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在 pom.xml 中，还将看到一个名为 <code>spring-cloud.version</code> 的属性，以及在 <code>&lt;dependencyManagement&gt;</code> 部分指定的 Spring Cloud 的版本。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Finchley.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>现在，构建中有了 Eureka starter 依赖项。然后，在应用程序的主引导类上，添加 <code>@EnableEurekaServer</code> 注解就可以启用 Eureka 服务：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceRegistryApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ServiceRegistryApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这样就可以了！现在启动应用程序，将会运行 Eureka 注册服务，并监听 8080 端口。使用浏览器访问 http://localhost:8080，我们将看到如下图所示的界面。</p> <p><img src="/note-pages/assets/img/image-20221215192339613.208e1d9f.png" alt="image-20221215192339613"></p> <p>Eureka 仪表盘信息很丰富，可以告诉我们有哪些服务实例在 Eureka 上注册了。</p> <p>Eureka 还提供了一个 REST API，通过 API 服务可以自行注册，并发现其他服务。你可能不会直接使用 REST API，但会发现 <code>/eureka/apps</code> 接口很有用。它详细列出了所有注册的服务实例。此时，由于还没有注册过任何服务实例，所以会得到以下的返回信息。当实际注册过服务以后，我们将在本章稍后的部分，重新查看这个接口的返回。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>applications</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>versions__delta</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>versions__delta</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>apps__hashcode</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>apps__hashcode</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>applications</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你可能已经注意到，Eureka 每隔 30 秒左右在其日志中记录了几个异常。别担心！这些异常只是表示，我们尚未完全配置好服务注册中心。让我们加上一些配置属性使这些异常消失吧。</p> <h3 id="配置-eureka"><a href="#配置-eureka" class="header-anchor">#</a> 配置 Eureka</h3> <p>Eureka 不喜欢独立工作。Eureka 相信多副本更安全的概念，并希望成为 Eureka 服务集群的一部分。如果有不止一个 Eureka 服务，那么只要其中一个正常运行，就能消除单点故障。因此，Eureka 的默认行为就是试图与其他 Eureka 服务建立关联。它将尝试从其他 Eureka 服务获取注册信息，甚至在其他 Eureka 服务上注册自己。</p> <p>在生产环境中，我们需要高可用性的 Eureka。但在开发环境，启动多个 Eureka 服务不方便，也没有必要。单个独立工作的 Eureka 服务足以满足开发环境的需求。但除非你正确配置了 Eureka 服务，否则它会不间断地尝试与其他 Eureka 服务建立联系。每隔30秒，会尝试与其他 Eureka 服务交换注册信息并相互注册，若出现问题则在日志文件中打印出异常。</p> <p>需要做的是，让 Eureka 知道自己是独立部署的。要做到这一点，需要设置 <code>application.yml</code> 中的一些属性，如下所示:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka
</code></pre></div><p>首先，设置 <code>eureka.instance.hostname</code> 属性为 localhost。这告诉 Eureka，它在什么主机上运行。这是可选属性，如果你不设置，那么 Eureka 会尝试从环境变量中确定宿主主机地址。显式设置此属性能够让你更确定的知道它的实际值。</p> <p>接下来的两个属性 <code>eureka.client.fetch-registry</code> 和 <code>eureka.client.register-with-eureka</code>，是可以在其他微服务上设置的属性，这会告诉它们应该如何与 Eureka 互动。Eureka 也是一个微服务，所以这些属性也可以设置在 Eureka 服务上。这告诉 Eureka 应如何与其他 Eureka 服务进行交互。</p> <p>这两个属性的默认值都为 true ，表示 Eureka 应该从其他 Eureka 实例获取注册信息，并将自己注册为其他 Eureka 服务的服务。现在，开发环境中，因为没有其他 Eureka 服务，我们将它们设置为 false，这样 Eureka 就不会试图访问其他 Eureka 服务了。</p> <p>最后，设置了 <code>eureka.client.service-url</code> 属性。此属性包含一组区域名称到 URL 的映射。每个区域可以设置多个 URL。<code>defaultZone</code> 键是一个特殊的区域名称，如果客户机（在本例中是 Eureka 本身）没有指定所需的区域，那么就使用此区域的值。因为只有一个 Eureka 实例，映射到默认区域的 URL 是用于 Eureka 服务本身的。这里的 URL 使用了可以被其他属性填充的占位符变量。</p> <div class="subtitle"><p>指定 EUREKA 的服务端口</p></div><p>尽管 Eureka 服务端口是选配的，但你可能希望覆盖默认设置。因为 Eureka 默认在端口 8080 上进行监听。如果你同时在本地计算机上运行几个应用程序（微服务），那这些应用程序就不能再监听 8080 端口了。因此，在开发环境中通常需要设置 Eureka 服务端口：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>
</code></pre></div><p>这里将端口设置为 8761，这是我们在后续章节中开发的 Eureka 客户端的默认监听端口。</p> <h3 id="扩展-eureka"><a href="#扩展-eureka" class="header-anchor">#</a> 扩展 Eureka</h3> <p>在生产环境中部署微服务时，需要考虑很多问题。虽然 Eureka 服务的高可用性和安全性，在开发环境不那么重要，但在生产环境中是至关重要的。</p> <p>配置两个（或更多）Eureka 实例的最简单、最直接的方法，就是在 application.yml 中使用 profiles 配置。然后多次启动 Eureka 服务，每次使用一个不同的 profile。例如，下面清单中的配置显示了，如何配置两个相互充当对等点的 Eureka 服务器。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>other.eureka.host<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>other.eureka.port<span class="token punctuation">}</span>/eureka

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span><span class="token number">1</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span><span class="token number">1</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka1.tacocloud.com

<span class="token key atrule">other</span><span class="token punctuation">:</span>
  <span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> eureka2.tacocloud.com
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8762</span>

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span><span class="token number">2</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span><span class="token number">2</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8762</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka2.tacocloud.com

<span class="token key atrule">other</span><span class="token punctuation">:</span>
  <span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> eureka1.tacocloud.com
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>
</code></pre></div><p>在默认 profile 之后，配置了两个 profile，一个命名为 <code>eureka-1</code>，另一个命名为 <code>eureka-2</code>。每个 profile 都为自己的配置指定自己的端口和实例名。在每个 profile 中设置了 <code>other.eureka.host</code> 和 <code>other.eureka.port</code> 两个属性，以引用另一个 Eureka 实例。这些属性是默认 profile 中的占位符所引用的属性，其他就没有什么特别之处了。</p> <p>请注意，没有设置 <code>eureka.client.fetch-registry</code> 或 <code>eureka.client.register-with-ereake</code>。默认值确保 Eureka 服务相互注册，并从另一个 Eureka 服务获取注册信息。</p> <h2 id="注册并发现服务"><a href="#注册并发现服务" class="header-anchor">#</a> 注册并发现服务</h2> <p>如果你的服务将被其他服务发现和使用，那么你需要使它们成为 Eureka 注册服务的客户端。要使应用程序（任何应用程序，假设是微服务）成为 Eureka 注册服务的客户端，必须做的是，将 Eureka 客户端依赖项添加到应用程序构建配置中：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>与 Eureka starter 服务依赖项一样，还需要在依赖管理中设置 Spring Cloud 版本属性：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
   ...
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Finchley.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

...

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你可以手动将这些条目添加到应用程序的 <code>pom.xml</code> 文件中，但更简单的方法是使用 Spring Initializr 的选择框，通过勾选 <code>Eureka Discovery</code> 以添加这些依赖项。</p> <p>Eureka starter 依赖项，会帮你添加使用 Eureka 发现服务所需的一切，包括 Eureka 的客户端库以及 Ribbon 负载均衡器。其他就什么也不用做了，这就使你的应用程序成为了 Eureka 服务的客户端。当应用程序启动时，它会尝试联系本地运行的 Eureka 服务并侦听端口 8761，并以 <code>UNKNOWN</code> 名称注册自己。</p> <h3 id="配置-eureka-客户端属性"><a href="#配置-eureka-客户端属性" class="header-anchor">#</a> 配置 Eureka 客户端属性</h3> <p>虽然本地开发时，在微服务中使用 Eureka 服务的默认位置 localhost 很适合，但一旦要把服务部署在本地主机之外，就需要覆盖它的配置。更重要的是，那个默认服务名称 <code>UNKNOWN</code>，实在是一个可怕的选择。</p> <p>更改微服务在 Eureka 中的注册名称，只需简单设置 <code>spring.application.name</code> 属性。例如，如果你要注册的服务，可以处理所有涉及 Taco Ingredient 的操作，那么你可以把它注册为 <code>ingredient-service</code>。在应用程序中的配置中，它应该是这样的：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingredient<span class="token punctuation">-</span>service
</code></pre></div><p>设置此属性后，就可以通过名称 <code>ingredient-service</code> 来查找该服务了。此外，如果你要启动多个 <code>ingredient-service</code> 的实例，它们都会出现在相同的名称下。这会有效地对服务进行水平扩展，以使消费服务可以选择多个等效的实例。在查看 Eureka 仪表盘时，服务将如下图所示。</p> <p><img src="/note-pages/assets/img/image-20221220210239923.d993ee2d.png" alt="image-20221220210239923"></p> <p>使用 Spring Cloud 一段时间之后，你会发现 <code>spring.application.name</code> 属性是你需要设置的最重要的属性之一。它指定了在 Eureka 中的注册名称。在下一章中，你将看到配置服务使用这个名称来识别不同应用程序，进而管理不同应用程序的特定配置。其他 Spring Cloud 项目，如 Spring Cloud Task（定时任务服务）和 Spring Cloud Sleuth（分布式链路跟踪）也依赖于 <code>spring.application.name</code> 属性识别微服务。</p> <p>正如你从第一章中了解到的那样， 在默认情况下，所有 Spring MVC 和 Spring WebFlux 应用程序都侦听端口 8080。因为你只会通过 Eureka 查找服务，所以这些应用程序在侦听哪个端口并不重要，因为 Eureka 知道他们在用哪个端口。因此，为了避免在本地运行时出现潜在的端口冲突，你可以将端口设置为 0：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">0</span>
</code></pre></div><blockquote><p>注意：将端口设置为 0 会导致在启动应用程序时，随机选择可用端口。</p></blockquote> <p>现在，看看 Eureka 服务的位置配置。默认情况下，Eureka 客户端假定 Eureka 正在监听本地主机（端口 8761）。这在开发环境很适合，但在生产环境中不适用。因此，你需要指定 Eureka 服务的位置。这与你配置 Eureka 服务本身时一样，通过设置 <code>eureka.client.service-url</code> 属性：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1.tacocloud.com<span class="token punctuation">:</span>8761/eureka/
</code></pre></div><p>这就配置了客户端要在 Eureka 服务上注册，并侦听主机 <code>eureka1.tacocloud.com</code>（端口8761）。只要这里指定的这个 Eureka 服务正常，这就能工作的很好。但如果这个 Eureka 服务因任何原因下线了，然后服务就无法注册了。为避免注册失败，最好使用两个或多个 Eureka 服务：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">client</span><span class="token punctuation">:</span>
  <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
    <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1.tacocloud.com<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>
                 http<span class="token punctuation">:</span>//eureka2.tacocloud.com<span class="token punctuation">:</span>8762/eureka/
</code></pre></div><p>当服务启动时，它会尝试向区域中的第一个 Eurreka 服务注册。如果由于一些原因注册失败了，那么它会尝试注册到列表中的下一个服务中。最终，当某个 Eureka 服务重新恢复时，它会从其他对等的点复制注册信息。</p> <p>在 Eureka 注册一个服务只完成了一半的工作。一旦服务注册到 Eureka 后，其他服务就可以发现它们并开始使用它们。让我们看看如何使用在 Eureka 中注册的服务。</p> <h3 id="消费服务"><a href="#消费服务" class="header-anchor">#</a> 消费服务</h3> <p>在消费者的代码中，硬编码任何服务实例的 URL 都将是错误的。这不仅将消费者与服务的特定实例相结合，而且如果服务的主机或端口要更改，还会导致消费服务中断。</p> <p>另一方面，当涉及在 Eureka 中查找服务时，消费应用程序还有一些工作，因为 Eureka 可能回复提供相同服务的多个实例。如果消费者查询 <code>ingredient-service</code> 服务，并收到六个服务实例，那该如何选择正确的服务实例呢？</p> <p>好消息是，消费应用程序不需要做出选择，甚至不需要自己明确地查找服务。Spring Cloud 的 Eureka 客户端，以及 Ribbon 负载均衡器，使查找、选择和使用一个服务实例变得很简单。使用从 Eureka 查找到的服务有两种方法，包括：</p> <ul><li>一个负载均衡的 RestTemplate</li> <li>Feign 接口生成的客户端</li></ul> <p>你可以根据个人喜好来选择。下面将介绍这两种方式，先从负载均衡 RestTemplate开始。然后你自己决定喜欢哪一个。</p> <div class="subtitle"><p>使用 RestTemplate 消费服务</p></div><p>重温一下 RestTemplate 是如何工作的。一旦创建或注入了 RestTemplate，你就可以发送 HTTP 调用，并将响应绑定到实体类上。例如，要执行 HTTP GET 请求，按 ID 检索 Ingredient，你可以使用以下 RestTemplate 代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Ingredient</span> <span class="token function">getIngredientById</span><span class="token punctuation">(</span><span class="token class-name">String</span> ingredientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rest<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/ingredients/{id}&quot;</span><span class="token punctuation">,</span>
                             <span class="token class-name">Ingredient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ingredientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码的唯一问题是，传递到 <code>getForObject()</code> 的 URL 是硬编码到特定的主机和端口的。虽然可以将 URL 提取到一个配置属性中，但如果请求是对 Ingredient 服务的多个实例之一，我们配置的任何 URL 都将只针对特定实例，而不能在多个实例中进行负载均衡。</p> <p>但是，一旦将应用程序设为 Eureka 客户端，你就可以声明这是一个带有负载均衡的 RestTemplate。你所需要做的，就是为方法添加 <code>@Bean</code> 和 <code>@LoadBalanced</code> 注解：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@LoadBalanced</code> 注解有两个目的：首先，它告诉 Spring Cloud，这个 RestTemplate 应该能够通过 Ribbon 查找服务。另外，它可以作为一个注入限定符。因为，如果你有两个或两个以上的 RestTemplate，这指定了要使用带有负载均衡的 RestTemplate。</p> <p>例如，你希望使用负载均衡的 RestTemplate，像以前的代码那样查找 Ingredient。首先，将负载均衡 RestTemplate 注入到实体：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IngredientServiceClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> rest<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">IngredientServiceClient</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LoadBalanced</span> <span class="token class-name">RestTemplate</span> rest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rest <span class="token operator">=</span> rest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><p>然后稍微改写一下 <code>getIngredientById()</code> 方法来获取 Ingredient，以便它使用服务的注册名称，而不是显式的指定主机和端口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Ingredient</span> <span class="token function">getIngredientById</span><span class="token punctuation">(</span><span class="token class-name">String</span> ingredientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rest<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://ingredient-service/ingredients/{id}&quot;</span><span class="token punctuation">,</span>
                             <span class="token class-name">Ingredient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ingredientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意到两者的区别了吗？为 <code>getForObject()</code> 指定的 URL，没有使用任何特定的主机名或端口。使用服务名称 <code>ingredient-service</code> 来代替主机名和端口。内部 RestTemplate 要求 Ribbon 查找服务并选择一个实例。Ribbon 很高兴提供帮助，重写 URL 以包含所选服务实例的主机和端口，然后让 RestTemplate 照常进行后续工作。</p> <p>正如你所看到的，使用负载均衡的 RestTemplate 与使用标准的 RestTemplate 并没有什么不同。关键不同在于，客户端代码只需要使用服务名称，而不是显式的主机名和端口。</p> <div class="subtitle"><p>使用 WebClient 消费服务</p></div><p>首先要做的是声明一个 WebClient，并添加 <code>@LoadBalanced</code> 注解到 <code>WebClient.Builder</code> 方法上：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> <span class="token function">webClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">WebClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了 <code>WebClient.Builder</code> bean，现在就可以注入到任何需要使用它的地方了。例如，你可以将其注入到 IngredientServiceClient 的构造函数中：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IngredientServiceClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> wcBuilder<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">IngredientServiceClient</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LoadBalanced</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> wcBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>wcBuilder <span class="token operator">=</span> wcBuilder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><p>最后，当你准备好使用它时，你可以使用 <code>WebClient.Builder</code> 以构建一个 WebClient，然后使用各服务在 Eureka 中注册的服务名称发出实际请求：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Ingredient</span><span class="token punctuation">&gt;</span></span> <span class="token function">getIngredientById</span><span class="token punctuation">(</span><span class="token class-name">String</span> ingredientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wcBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://ingredient-service/ingredients/{id}&quot;</span><span class="token punctuation">,</span> ingredientId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">Ingredient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与负载均衡的 RestTemplate 一样，在发出请求时无需明确指定主机或端口。服务名称将从给定的 URL 中提取，并用来从 Eureka 查找服务。然后，Ribbon 将选择一个服务实例，并且在发出请求之前，使用所选实例的主机和端口重写 URL。</p> <div class="subtitle"><p>定义 Feign 接口客户端</p></div><p>Feign 是一个 REST 客户端库，它用一种独特的、接口驱动的方式来定义 REST 客户端。</p> <p>Feign 最初是 Netflix 公司的一个项目，但后来作为了一个独立开源项目，名为 OpenFeign (https://github.com/OpenFeign)。<code>Feign</code> 这个词的意思是 “假装”，你很快就会看到，使用这个词，对于假装的 REST 的客户端确实是非常合适。</p> <p>使用 Feign 的第一步是将依赖项添加到项目中。在 pom.xml 中，以下 <code>&lt;dependency&gt;</code> 做到了这一点：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>使用 Spring Initializr 时，可以通过选中 <code>Feign</code> 复选框，自动添加启动依赖项。不幸的是，基于这个依赖的自动配置无法自动启用 Feign。因此，需要将 <code>@EnableFeignClient</code> 注解添加到其中一个配置类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token class-name">RestClientConfiguration</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，有趣的部分来了。假设你想写一个客户端，从 Eureka 注册表中获取 <code>ingredient-service</code> 服务，并进而获取 Ingredient。你应该像下面这样使用：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">tacos<span class="token punctuation">.</span>ingredientclient<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">tacos<span class="token punctuation">.</span>ingredientclient<span class="token punctuation">.</span></span><span class="token class-name">Ingredient</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;ingredient-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IngredientClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ingredients/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Ingredient</span> <span class="token function">getIngredient</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这是一个简单的接口，没有实现。但在运行时，当 Feign 接管以后，这些都不重要。Feign 会自动创建一个实现，并将其公开为 Spring 应用程序上下文的一个 bean。</p> <p>接口级的 <code>@FeignClient</code> 注解，指明了在此接口中声明的任何方法，将对名称为 <code>ingredient-service</code> 的服务发出请求。在内部，将通过 Ribbon 查找，就像使用 RestTemplate 时那样。</p> <p>然后是 <code>getIngredient()</code> 方法，你一定认出了来自于 Spring MVC 的 <code>@GetMapping</code> 注解。事实上，确实是同样的注解！只是这次是用在客户端上，而不是在 Controller 上。也就是说，任何对 <code>getIngredient()</code> 的调用，都将导致 Ribbon 选择相应主机和端口，并把 GET 请求转到 <code>/ingredients/{id}</code> 上。<code>@PathVariable</code> 注解同样来自 Spring MVC，会将参数映射到给定路径中的占位符中。</p> <p>剩下的就是在需要时注入 Feign 实现的接口，并开始使用它。例如，要在 Controller 中使用它，你可以执行这样的操作：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ingredients&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IngredientController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">IngredientClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">IngredientController</span><span class="token punctuation">(</span><span class="token class-name">IngredientClient</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">ingredientDetailPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span>
                                       <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;ingredient&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getIngredient</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ingredientDetail&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>另外，Feign 有自己的一组注解。<code>@RequestLine</code> 和 <code>@Param</code> 大致类似于 Spring MVC 的 <code>@RequestMapping</code> 和 <code>@PathVariable</code>，只是使用方式有点差异。不过，能够在客户端上使用已经熟悉的 Spring MVC 注解，这一点是相当好的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note-pages/spring/Web中的Spring/SpringMVC的高级技术.html" class="prev">
        Spring MVC 的高级技术
      </a></span> <span class="next"><a href="/note-pages/spring/云原生Spring/配置管理.html">
        配置管理
      </a>
      →
    </span></p></div> </main> <aside items="[object Object],[object Object],[object Object],[object Object]" class="right-sidebar"><div style="margin-left:20px; margin-bottom: 10px; text-align: center; font-size:16px;font-weight:bold;">此页内容</div> <div class="right-sidebar-wrap"><ul class="right-sidebar-links"><li id="tab-item0" class="right-sidebar-item active"><a href="#深入思考微服务" class="right-sidebar-item-level2">
          深入思考微服务
        </a></li><li id="tab-item1" class="right-sidebar-item"><a href="#配置服务注册" class="right-sidebar-item-level2">
          配置服务注册
        </a></li><li id="tab-item2" class="right-sidebar-item"><a href="#配置-eureka" class="right-sidebar-item-level3">
          配置 Eureka
        </a></li><li id="tab-item3" class="right-sidebar-item"><a href="#扩展-eureka" class="right-sidebar-item-level3">
          扩展 Eureka
        </a></li><li id="tab-item4" class="right-sidebar-item"><a href="#注册并发现服务" class="right-sidebar-item-level2">
          注册并发现服务
        </a></li><li id="tab-item5" class="right-sidebar-item"><a href="#配置-eureka-客户端属性" class="right-sidebar-item-level3">
          配置 Eureka 客户端属性
        </a></li><li id="tab-item6" class="right-sidebar-item"><a href="#消费服务" class="right-sidebar-item-level3">
          消费服务
        </a></li></ul></div></aside></div><div class="global-ui"></div></div>
    <script src="/note-pages/assets/js/app.05dcbd87.js" defer></script><script src="/note-pages/assets/js/3.4a2f67fd.js" defer></script><script src="/note-pages/assets/js/2.ab82720e.js" defer></script><script src="/note-pages/assets/js/57.b3f75d67.js" defer></script>
  </body>
</html>
